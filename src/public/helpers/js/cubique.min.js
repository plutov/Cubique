/**
 * Cubique
 * @author    Alexander Plutov
 * @copyright (c) 2011-2012 Alexander Plutov
 * @link      https://github.com/plutov/cubique
 * @license   https://github.com/plutov/cubique/blob/master/LICENSE
 */
Cubique=function(b){$.extend(this,b);this.count=0;this.currPage=1;this.sort="";this.search={};var e=[10,25,50,100];e.push(this.rowsOnPage);e.sort(function(g,f){return g-f});e.join();if(this.isLocalStorageAvailable()){var c=parseInt(localStorage.getItem(this.name+"_rowsOnPage"));var d=parseInt(localStorage.getItem(this.name+"_currPage"));if(c&&$.inArray(c,e)!=-1){this.rowsOnPage=c;if(d){this.currPage=d}}else{localStorage.setItem(this.name+"_rowsOnPage",this.rowsOnPage);localStorage.setItem(this.name+"_currPage",this.currPage)}}else{var c=parseInt(this.getCookie(this.name+"_rowsOnPage"));var d=parseInt(this.getCookie(this.name+"_currPage"));if(c&&$.inArray(c,e)!=-1){this.rowsOnPage=c;if(d){this.currPage=d}}else{this.setCookie(this.name+"_rowsOnPage",this.rowsOnPage);this.setCookie(this.name+"_currPage",this.currPage)}}this.perPageOptions={};for(var a in e){this.perPageOptions[e[a]]=e[a]}this.searchValues={};this.renderGrid();this.showData()};Cubique.prototype.renderGrid=function Cubique_renderGrid(){var f='<table class="cubique"><thead><tr>';var c="";for(var e in this.columns){if(typeof(this.columnsToSort[e])!="undefined"){c='<span class="order"></span> <a href="#" class="sort-by" data-column="'+e+'" data-order="ASC">'+this.columns[e]+"</a>"}else{c=this.columns[e]}f+="<th>"+c+"</th>"}f+="</tr>";var g='<select class="search-type"></select>';if(this.getObjectSize(this.columnsToSearch)){f+="<tr>";for(var d in this.columns){if(typeof(this.columnsToSearch[d])!="undefined"){c='<select class="search-type"><option value="LIKE">LIKE</option><option value="=">=</option><option value="<>"><></option><option value="<"><</option><option value=">">></option><option value="<="><=</option><option value=">=">>=</option></select><input type="text" data-column="'+d+'" placeholder="search"/> <a href="#" class="reset-search">&times</a>';this.searchValues[d]=""}else{c=""}f+="<th>"+c+"</th>"}f+="</tr>"}f+="</thead><tbody></tbody></table>";$("#cubique-"+this.name).html(f);var b="ASC";var a="";var h=this;var k=$("#cubique-"+this.name+" a.sort-by");k.click(function(){k.prev("span").html("");b=$(this).attr("data-order");a=$(this).attr("data-column");h.currPage=1;h.sort=a+" "+b;$(this).attr("data-order",b=="ASC"?"DESC":"ASC");$(this).prev("span").html(b=="ASC"?"&darr;":"&uarr;");h.showData();return false});$("#cubique-"+this.name+" input").keyup(function(){h.makeSearch($(this),$(this).prev("select"));return false});$("#cubique-"+this.name+" .search-type").change(function(){h.makeSearch($(this).next("input"),$(this));return false});$(".reset-search").click(function(){var j=$(this).prev();var i=j.prev();j.val(null);i.val("LIKE");h.makeSearch(j,i);return false});this.tbody=$("#cubique-"+this.name+" tbody");this.thead=$("#cubique-"+this.name+" thead")};Cubique.prototype.showData=function Cubique_showData(){var c=this.getObjectSize(this.columns);var d=$('<tr><td colspan="'+c+'" class="loading">.</td></tr>');var b=setInterval(function(){$(".loading").html($(".loading").html()+".")},50);this.tbody.html(d);var a=this;$.ajax({type:"post",data:{cubique:{name:a.name,curr_page:a.currPage,sort:a.sort,search:a.search,rows_on_page:a.rowsOnPage}},url:a.url?a.url:location.href,dataType:"json",success:function(f){if(f.error){a.tbody.html('<tr><td colspan="'+c+'" class="error">'+a.error_message+"</td></tr>")}else{a.count=f.count;var g="";for(var h in f.data){g+="<tr>";for(var e in f.data[h]){if(null==f.data[h][e]){f.data[h][e]=""}g+="<td>"+f.data[h][e]+"</td>"}g+="</tr>"}a.tbody.html(g);$("table.cubique tbody td").mouseover(function(){$(this).parent().addClass("hovered")}).mouseleave(function(){$(this).parent().removeClass("hovered")});a.thead.find(".pages").remove();a.renderPagesSection()}clearInterval(b);d.remove()}})};Cubique.prototype.renderPagesSection=function Cubique_renderPagesSection(){var b="";var a=Math.ceil(this.count/this.rowsOnPage);var g=1;var h=a;var k='<span class="more">...</span>';if(a>10){if(this.currPage<=6){g=1;h=10}else{if(a-this.currPage<=5){g=a-11;h=a;b+=this.getGoToPageLink(1,false)+k}else{g=this.currPage-5;h=(this.currPage+5<=a)?this.currPage+5:a;b+=this.getGoToPageLink(1,false);if(this.currPage>7){b+=k}}}}var d=null;for(d=g;d<=h;d++){b+=this.getGoToPageLink(d,d==this.currPage)}if(a>h){if(a-this.currPage>=7){b+=k}b+=this.getGoToPageLink(a,false)}var f='<select class="per-page">';var c=null;for(c in this.perPageOptions){f+='<option value="'+this.perPageOptions[c]+'">'+this.perPageOptions[c]+"</option>"}f+="</select>";this.thead.append($('<tr class="pages"><th colspan="'+this.getObjectSize(this.columns)+'">'+b+f+'<span class="in-total">'+this.count+" in total</span></th></tr>"));var e=this;this.thead.find(".go-to-page").click(function(){e.currPage=parseInt($(this).attr("data-number"));if(e.isLocalStorageAvailable()){localStorage.setItem(e.name+"_currPage",e.currPage)}else{e.setCookie(e.name+"_currPage",e.currPage)}e.showData();return false});this.thead.find(".per-page").change(function(){e.rowsOnPage=$(this).val();if(e.isLocalStorageAvailable()){localStorage.setItem(e.name+"_rowsOnPage",e.rowsOnPage);localStorage.setItem(e.name+"_currPage",1)}else{e.setCookie(e.name+"_rowsOnPage",e.rowsOnPage);e.setCookie(e.name+"_currPage",1)}e.currPage=1;e.showData();return false}).val(this.rowsOnPage)};Cubique.prototype.getGoToPageLink=function Cubique_getGoToPageLink(b,a){return'<a href="#" class="go-to-page'+(a?" curr":"")+'" data-number="'+b+'">'+b+"</a>"};Cubique.prototype.getObjectSize=function Cubique_getObjectSize(c){var b=0;for(var a in c){if(c.hasOwnProperty(a)){b++}}return b};Cubique.prototype.isLocalStorageAvailable=function Cubique_isLocalStorageAvailable(){try{return"localStorage" in window&&window.localStorage!==null}catch(a){return false}};Cubique.prototype.makeSearch=function Cubique_makeSearch(d,c){var a=d.attr("data-column");var b=[d.val(),c.val()];if(this.searchValues[a]!=b){this.search[a]=b;this.searchValues[a]=b;this.currPage=1;this.showData()}};Cubique.prototype.setCookie=function Cubique_setCookie(c,d){var b=new Date();var a=new Date();a.setTime(b.getTime()+3600000*24*10);document.cookie=c+"="+d+";expires="+a.toGMTString()+";path=/"};Cubique.prototype.getCookie=function Cubique_getCookie(b){var d=" "+document.cookie;var c=" "+b+"=";var e="";var f=0;var a=0;if(d.length>0){f=d.indexOf(c);if(f!=-1){f+=c.length;a=d.indexOf(";",f);if(a==-1){a=d.length}e=d.substring(f,a)}}return(e)};