/**
 * Cubique
 * @author    Alexander Plutov
 * @copyright (c) 2011 Alexander Plutov
 * @license   https://github.com/plutov/cubique/wiki/License
 */
Cubique=function(b){$.extend(this,b);this.count=0;this.currPage=1;this.sort="";this.search={};var e=[10,25,50,100];e.push(this.rowsOnPage);e.sort(function(g,f){return g-f});e.join();if(this.isLocalStorageAvailable()){var c=parseInt(localStorage.getItem(this.name+"_rowsOnPage"));var d=parseInt(localStorage.getItem(this.name+"_currPage"));if(c&&$.inArray(c,e)!=-1){this.rowsOnPage=c;if(d){this.currPage=d}}else{localStorage.setItem(this.name+"_rowsOnPage",10)}}this.perPageOptions={};for(var a in e){this.perPageOptions[e[a]]=e[a]}this.renderGrid();this.showData()};Cubique.prototype.renderGrid=function Cubique_renderGrid(){var g='<table class="cubique"><thead><tr>';var d="";for(var f in this.columns){if(typeof(this.columnsToSort[f])!="undefined"){d='<span></span> <a href="#" class="sort-by" data-column="'+f+'" data-order="ASC">'+this.columns[f]+"</a>"}else{d=this.columns[f]}g+="<th>"+d+"</th>"}g+="</tr>";var a={};if(this.getObjectSize(this.columnsToSearch)){g+="<tr>";for(var e in this.columns){if(typeof(this.columnsToSearch[e])!="undefined"){d='<input type="text" data-column="'+e+'" placeholder="search"/>';a[e]=""}else{d=""}g+="<th>"+d+"</th>"}g+="</tr>"}g+="</thead><tbody></tbody></table>";$("#cubique-"+this.name).html(g);var c="ASC";var b="";var l=this;var m=$("#cubique-"+this.name+" a.sort-by");m.click(function(){m.prev("span").html("");c=$(this).attr("data-order");b=$(this).attr("data-column");l.currPage=1;l.sort=b+" "+c;$(this).attr("data-order",c=="ASC"?"DESC":"ASC");$(this).prev("span").html(c=="ASC"?"&darr;":"&uarr;");l.showData();return false});var h=null;var k="";$("#cubique-"+this.name+" input").keyup(function(){h=$(this).attr("data-column");k=$(this).val();if(a[h]!=k){l.search[h]=k;a[h]=k;l.currPage=1;l.showData()}return false});this.tbody=$("#cubique-"+this.name+" tbody");this.thead=$("#cubique-"+this.name+" thead")};Cubique.prototype.showData=function Cubique_showData(){var b=this.getObjectSize(this.columns);var c=$('<tr><td colspan="'+b+'" class="loading"><img src="/helpers/img/cubique_loading.gif"/></td></tr>');this.tbody.html(c);var a=this;$.ajax({type:"post",data:{cubique:{name:a.name,curr_page:a.currPage,sort:a.sort,search:a.search,rows_on_page:a.rowsOnPage}},url:a.url?a.url:location.href,dataType:"json",success:function(e){if(e.error){a.tbody.html('<tr><td colspan="'+b+'" class="error">'+a.error_message+"</td></tr>")}else{a.count=e.count;var f="";for(var g in e.data){f+="<tr>";for(var d in e.data[g]){if(null==e.data[g][d]){e.data[g][d]=""}f+="<td>"+e.data[g][d]+"</td>"}f+="</tr>"}a.tbody.html(f);$("table.cubique tbody td").mouseover(function(){$(this).parent().addClass("hovered")}).mouseleave(function(){$(this).parent().removeClass("hovered")});a.thead.find(".pages").remove();a.renderPagesSection()}c.remove()}})};Cubique.prototype.renderPagesSection=function Cubique_renderPagesSection(){var b="";var c="";var f=Math.ceil(this.count/this.rowsOnPage);var h=1;var g=f;if(f>10){if(this.currPage<=6){h=1;g=10}else{if(f-this.currPage<=5){h=f-11;g=f;b+=this.getGoToPageLink(1,false)+"..."}else{h=this.currPage-5;g=(this.currPage+5<=f)?this.currPage+5:f;b+=this.getGoToPageLink(1,false);if(this.currPage>7){b+="..."}}}}for(var e=h;e<=g;e++){b+=this.getGoToPageLink(e,e==this.currPage)}if(f>g){if(f-this.currPage>=7){b+="..."}b+=this.getGoToPageLink(f,false)}var a='<select class="per-page">';for(var e in this.perPageOptions){a+='<option value="'+this.perPageOptions[e]+'">'+this.perPageOptions[e]+"</option>"}a+="</select>";this.thead.append($('<tr class="pages"><th colspan="'+this.getObjectSize(this.columns)+'">'+b+a+'<span class="in-total">'+this.count+" in total</span></th></tr>"));var d=this;this.thead.find(".go-to-page").click(function(){d.currPage=parseInt($(this).attr("data-number"));if(d.isLocalStorageAvailable()){localStorage.setItem(d.name+"_currPage",d.currPage)}d.showData();return false});this.thead.find(".per-page").change(function(){d.rowsOnPage=$(this).val();if(d.isLocalStorageAvailable()){localStorage.setItem(d.name+"_rowsOnPage",d.rowsOnPage);localStorage.setItem(d.name+"_currPage",1)}d.currPage=1;d.showData();return false}).val(this.rowsOnPage)};Cubique.prototype.getGoToPageLink=function Cubique_getGoToPageLink(b,a){return'<a href="#" class="go-to-page'+(a?" curr":"")+'" data-number="'+b+'">'+b+"</a>"};Cubique.prototype.getObjectSize=function Cubique_getObjectSize(c){var b=0;for(var a in c){if(c.hasOwnProperty(a)){b++}}return b};Cubique.prototype.isLocalStorageAvailable=function Cubique_isLocalStorageAvailable(){try{return"localStorage" in window&&window.localStorage!==null}catch(a){return false}};