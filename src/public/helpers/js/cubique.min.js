/**
 * Cubique
 * @author    Alexander Plutov
 * @copyright (c) 2011-2012 Alexander Plutov
 * @link      https://github.com/plutov/cubique
 * @license   https://github.com/plutov/cubique/blob/master/LICENSE
 */
Cubique=function(g){var d="_rowsOnPage",a=this;$.extend(a,g);a.count=0;a.currPage=1;a.sort="";a.search={};var b=[10,25,50,100];b.push(a.rowsOnPage);b.sort(function(a,b){return a-b});b.join();if(a.isLocalStorageAvailable()){var c=parseInt(localStorage.getItem(a.name+d)),e=parseInt(localStorage.getItem(a.name+"_currPage"));if(c&&$.inArray(c,b)!=-1){a.rowsOnPage=c;if(e)a.currPage=e}else localStorage.setItem(a.name+d,10)}a.perPageOptions={};for(var f in b)a.perPageOptions[b[f]]=b[f];a.searchValues={};a.renderGrid();a.showData()};Cubique.prototype.renderGrid=function(){var g=false,f="ASC",c="#cubique-",k="undefined",a=this,b='<table class="cubique"><thead><tr>',d="";for(var i in a.columns){if(typeof a.columnsToSort[i]!=k)d='<span class="order"></span> <a href="#" class="sort-by" data-column="'+i+'" data-order="ASC">'+a.columns[i]+"</a>";else d=a.columns[i];b+="<th>"+d+"</th>"}b+="</tr>";var n='<select class="search-type"></select>';if(a.getObjectSize(a.columnsToSearch)){b+="<tr>";for(var j in a.columns){if(typeof a.columnsToSearch[j]!=k){d='<select class="search-type"><option value="LIKE">LIKE</option><option value="=">=</option><option value="<>"><></option><option value="<"><</option><option value=">">></option><option value="<="><=</option><option value=">=">>=</option></select><input type="text" data-column="'+j+'" placeholder="search"/> <a href="#" class="reset-search">&times</a>';a.searchValues[j]=""}else d="";b+="<th>"+d+"</th>"}b+="</tr>"}b+="</thead><tbody></tbody></table>";$(c+a.name).html(b);var h=f,l="",e=a,m=$(c+a.name+" a.sort-by");m.click(function(){var b="data-order",a=this;m.prev("span").html("");h=$(a).attr(b);l=$(a).attr("data-column");e.currPage=1;e.sort=l+" "+h;$(a).attr(b,h==f?"DESC":f);$(a).prev("span").html(h==f?"&darr;":"&uarr;");e.showData();return g});$(c+a.name+" input").keyup(function(){e.makeSearch($(this),$(this).prev("select"));return g});$(c+a.name+" .search-type").change(function(){e.makeSearch($(this).next("input"),$(this));return g});$(".reset-search").click(function(){var a=$(this).prev(),b=a.prev();a.val(null);b.val("LIKE");e.makeSearch(a,b);return g});a.tbody=$(c+a.name+" tbody");a.thead=$(c+a.name+" thead")};Cubique.prototype.showData=function(){var c='<tr><td colspan="',b=this,d=b.getObjectSize(b.columns),e=$(c+d+'" class="loading">.</td></tr>'),f=setInterval(function(){var a=".loading";$(a).html($(a).html()+".")},50);b.tbody.html(e);var a=b;$.ajax({type:"post",data:{cubique:{name:a.name,curr_page:a.currPage,sort:a.sort,search:a.search,rows_on_page:a.rowsOnPage}},url:a.url?a.url:location.href,dataType:"json",success:function(b){if(b.error)a.tbody.html(c+d+'" class="error">'+a.error_message+"</td></tr>");else{a.count=b.count;var h="";for(var g in b.data){h+="<tr>";for(var i in b.data[g]){if(null==b.data[g][i])b.data[g][i]="";h+="<td>"+b.data[g][i]+"</td>"}h+="</tr>"}a.tbody.html(h);$("table.cubique tbody td").mouseover(function(){$(this).parent().addClass("hovered")}).mouseleave(function(){$(this).parent().removeClass("hovered")});a.thead.find(".pages").remove();a.renderPagesSection()}clearInterval(f);e.remove()}})};Cubique.prototype.renderPagesSection=function(){var l="_currPage",e=false,a=this,d="",c=Math.ceil(a.count/a.rowsOnPage),g=1,f=c,i='<span class="more">...</span>';if(c>10)if(a.currPage<=6){g=1;f=10}else if(c-a.currPage<=5){g=c-11;f=c;d+=a.getGoToPageLink(1,e)+i}else{g=a.currPage-5;f=a.currPage+5<=c?a.currPage+5:c;d+=a.getGoToPageLink(1,e);if(a.currPage>7)d+=i}for(var h=null,h=g;h<=f;h++)d+=a.getGoToPageLink(h,h==a.currPage);if(c>f){if(c-a.currPage>=7)d+=i;d+=a.getGoToPageLink(c,e)}var j='<select class="per-page">',k=null;for(k in a.perPageOptions)j+='<option value="'+a.perPageOptions[k]+'">'+a.perPageOptions[k]+"</option>";j+="</select>";a.thead.append($('<tr class="pages"><th colspan="'+a.getObjectSize(a.columns)+'">'+d+j+'<span class="in-total">'+a.count+" in total</span></th></tr>"));var b=a;a.thead.find(".go-to-page").click(function(){b.currPage=parseInt($(this).attr("data-number"));b.isLocalStorageAvailable()&&localStorage.setItem(b.name+l,b.currPage);b.showData();return e});a.thead.find(".per-page").change(function(){b.rowsOnPage=$(this).val();if(b.isLocalStorageAvailable()){localStorage.setItem(b.name+"_rowsOnPage",b.rowsOnPage);localStorage.setItem(b.name+l,1)}b.currPage=1;b.showData();return e}).val(a.rowsOnPage)};Cubique.prototype.getGoToPageLink=function(a,b){return'<a href="#" class="go-to-page'+(b?" curr":"")+'" data-number="'+a+'">'+a+"</a>"};Cubique.prototype.getObjectSize=function(b){var a=0;for(var c in b)if(b.hasOwnProperty(c))a++;return a};Cubique.prototype.isLocalStorageAvailable=function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return false}};Cubique.prototype.makeSearch=function(d,e){var a=this,b=d.attr("data-column"),c=[d.val(),e.val()];if(a.searchValues[b]!=c){a.search[b]=c;a.searchValues[b]=c;a.currPage=1;a.showData()}};