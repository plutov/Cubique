/**
 * Cubique
 * @author    Alexander Plutov
 * @copyright (c) 2011 Alexander Plutov
 * @license   https://github.com/plutov/cubique/wiki/License
 */
Cubique=function(b){for(var c in b){this[c]=b[c]}this.count=0;this.currPage=1;this.sort="";this.search={};var f=[10,25,50,100];if(isLocalStorageAvailable()){var d=localStorage.getItem(this.name+"_rowsOnPage");var e=localStorage.getItem(this.name+"_currPage");if(d){this.rowsOnPage=d}if(e){this.currPage=e}}f.push(this.rowsOnPage);f.sort(function(h,g){return h-g});f.join();this.perPageOptions={};for(var a in f){this.perPageOptions[f[a]]=f[a]}this.renderGrid();this.showData()};Cubique.prototype.renderGrid=function Cubique_renderGrid(){var d='<table class="cubique"><thead><tr>';var f="";for(var c in this.columns){if(typeof(this.columnsToSort[c])!="undefined"){f='<span></span> <a href="#" class="sort-by" sort-column="'+c+'" sort-rotation="ASC">'+this.columns[c]+"</a>"}else{f=this.columns[c]}d+="<th>"+f+"</th>"}d+="</tr>";if(Object.size(this.columnsToSearch)){d+="<tr>";for(var a in this.columns){if(typeof(this.columnsToSearch[a])!="undefined"){f='<input type="text" search-column="'+a+'" placeholder="search"/>'}else{f=""}d+="<th>"+f+"</th>"}d+="</tr>"}d+="</thead><tbody></tbody></table>";$("#cubique-"+this.name).html(d);var e="ASC";var g="";var b=this;$("#cubique-"+this.name+" a.sort-by").click(function(){$("#cubique-"+b.name+" a.sort-by").prev("span").html("");e=$(this).attr("sort-rotation");g=$(this).attr("sort-column");b.currPage=1;b.sort=g+" "+e;$(this).attr("sort-rotation",e=="ASC"?"DESC":"ASC");$(this).prev("span").html(e=="ASC"?"&darr;":"&uarr;");b.showData();return false});$("#cubique-"+this.name+" input").keyup(function(){b.search[$(this).attr("search-column")]=$(this).val();b.currPage=1;b.showData();return false});this.tbody=$("#cubique-"+this.name+" tbody")};Cubique.prototype.showData=function Cubique_showData(){var b=Object.size(this.columns);var c=$('<tr><td colspan="'+b+'" class="loading"><img src="/helpers/img/cubique_loading.gif"/></td></tr>');this.tbody.html(c);var a=this;$.ajax({type:"post",data:{cubique_grid_name:a.name,cubique_grid_curr_page:a.currPage,cubique_grid_sort:a.sort,cubique_grid_search:a.search,cubique_grid_rows_on_page:a.rowsOnPage},url:a.url?a.url:location.href,dataType:"json",success:function(e){if(e.error){a.tbody.html('<tr><td colspan="'+b+'" class="error">Error has been occurred. Try to refresh the page.</td></tr>')}else{a.count=e.count;var f="";for(var g in e.data){f+="<tr>";for(var d in e.data[g]){if(null==e.data[g][d]){e.data[g][d]=""}f+="<td>"+e.data[g][d]+"</td>"}f+="</tr>"}a.tbody.html(f);$("table.cubique tbody td").mouseover(function(){$(this).parent().addClass("hovered")}).mouseleave(function(){$(this).parent().removeClass("hovered")});a.tbody.prev("thead").find(".pages").remove();a.renderPagesSection()}c.remove()}})};Cubique.prototype.renderPagesSection=function Cubique_renderPagesSection(){var c="";var n="...";var k="";var a=Math.ceil(this.count/this.rowsOnPage);var l=1;var f=10;var b=5;var m=a;if(a>f){if(this.currPage<=b+1){l=1;m=f}else{if(a-this.currPage<=b){l=a-f+1;m=a;c+='<a href="#" class="go-to-page" page-number="1">1</a>'+n}else{l=this.currPage-b;m=(this.currPage+b<=a)?this.currPage+b:a;c+='<a href="#" class="go-to-page" page-number="1">1</a>';if(this.currPage-b>2){c+=n}}}}for(var d=l;d<=m;d++){k=d==this.currPage?" curr":"";c+='<a href="#" class="go-to-page'+k+'" page-number="'+d+'">'+d+"</a>"}if(a>m){if(a-this.currPage>=b+2){c+=n}c+='<a href="#" class="go-to-page" page-number="'+a+'">'+a+"</a>"}var j='<select class="per-page">';for(var d in this.perPageOptions){j+='<option value="'+this.perPageOptions[d]+'">'+this.perPageOptions[d]+"</option>"}j+="</select>";var e=$('<tr class="pages"><th colspan="'+Object.size(this.columns)+'">'+c+j+'<span class="in-total">'+this.count+" in total</span></th></tr>");var g=this.tbody.prev("thead");g.append(e);var h=this;g.find(".go-to-page").click(function(){h.currPage=parseInt($(this).attr("page-number"));if(isLocalStorageAvailable()){localStorage.setItem(h.name+"_currPage",h.currPage)}h.showData();return false});g.find(".per-page").change(function(){h.rowsOnPage=$(this).val();if(isLocalStorageAvailable()){localStorage.setItem(h.name+"_rowsOnPage",h.rowsOnPage);localStorage.setItem(h.name+"_currPage",1)}h.currPage=1;h.showData();return false}).val(this.rowsOnPage)};Object.size=function(c){var b=0;for(var a in c){if(c.hasOwnProperty(a)){b++}}return b};function isLocalStorageAvailable(){try{return"localStorage" in window&&window.localStorage!==null}catch(a){return false}};