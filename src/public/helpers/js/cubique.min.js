/**
 * Cubique
 * @author    Alexander Plutov
 * @copyright (c) 2011-2012 Alexander Plutov
 * @link      https://github.com/plutov/cubique
 * @license   https://github.com/plutov/cubique/blob/master/LICENSE
 */
Cubique=function(h){$.extend(this,h);this.count=0;this.currPage=1;this.sort="";this.search={};this.searchValues={};var f=[10,25,50,100];f.push(this.rowsOnPage);f.sort(function(k,j){return k-j});f.join();var d=parseInt(this.getState("rowsOnPage"));var c=parseInt(this.getState("currPage"));var g=this.getState("sortColumn");var i=this.getState("sortOrder");var e=this;var a=$.parseJSON(e.getState("search"));if(g&&i){this.sort=g+" "+i}if(d&&$.inArray(d,f)!=-1){this.rowsOnPage=d;if(c){this.currPage=c}}else{this.setState("rowsOnPage",this.rowsOnPage);this.setState("currPage",this.currPage)}if(a){this.search=a}this.perPageOptions={};for(var b in f){this.perPageOptions[f[b]]=f[b]}this.renderGrid();this.showData()};Cubique.prototype.renderGrid=function Cubique_renderGrid(){var h='<table class="cubique"><thead><tr>';var e="";var p=this.getState("sortColumn");var q=this.getState("sortOrder");var l="";var k="ASC";for(var g in this.columns){if(typeof(this.columnsToSort[g])!="undefined"){l=(p==this.columnsToSort[g])?(q=="ASC"?"&#9660":"&#9650"):"";k=(p==this.columnsToSort[g])?(q=="ASC"?"DESC":"ASC"):"ASC";e='<span class="order">'+l+'</span> <a href="#" class="sort-by" data-column="'+g+'" data-order="'+k+'">'+this.columns[g]+"</a>"}else{e=this.columns[g]}h+="<th>"+e+"</th>"}h+="</tr>";var m='<select class="search-type"></select>';if(this.getObjectSize(this.columnsToSearch)){h+="<tr>";var a="";var d="";for(var f in this.columns){if(typeof(this.columnsToSearch[f])!="undefined"){a=(typeof(this.search[f])!="undefined")?this.search[f][0]:"";d=(typeof(this.search[f])!="undefined")?this.search[f][1]:"";e='<select class="search-type"><option value="LIKE"'+(d=="LIKE"?" selected=selected":"")+'>LIKE</option><option value="="'+(d=="="?" selected=selected":"")+'>=</option><option value="<>"'+(d=="<>"?" selected=selected":"")+'><></option><option value="<"'+(d=="<"?" selected=selected":"")+'><</option><option value=">"'+(d==">"?" selected=selected":"")+'>></option><option value="<="'+(d=="<="?" selected=selected":"")+'><=</option><option value=">="'+(d==">="?" selected=selected":"")+'>>=</option></select><input type="text" data-column="'+f+'" placeholder="search" value="'+a+'"/> <a href="#" class="reset-search">&times;</a>';if(typeof(this.search[f])!="undefined"){this.searchValues[f]=this.search[f]}else{this.searchValues[f]=""}}else{e=""}h+="<th>"+e+"</th>"}h+="</tr>"}h+="</thead><tbody></tbody></table>";$("#cubique-"+this.name).html(h);var c="ASC";var b="";var n=this;var o=$("#cubique-"+this.name+" a.sort-by");o.click(function(){o.prev("span").html("");c=$(this).attr("data-order");b=$(this).attr("data-column");n.currPage=1;n.sort=b+" "+c;n.setState("currPage",1);n.setState("sortColumn",b);n.setState("sortOrder",c);$(this).attr("data-order",c=="ASC"?"DESC":"ASC");$(this).prev("span").html(c=="ASC"?"&#9660;":"&#9650;");n.showData();return false});$("#cubique-"+this.name+" input").keyup(function(){n.makeSearch($(this),$(this).prev("select"));return false});$("#cubique-"+this.name+" .search-type").change(function(){n.makeSearch($(this).next("input"),$(this));return false});$("#cubique-"+this.name+" .reset-search").click(function(){var j=$(this).prev();var i=j.prev();j.val(null);i.val("LIKE");n.makeSearch(j,i);return false});this.tbody=$("#cubique-"+this.name+" tbody");this.thead=$("#cubique-"+this.name+" thead")};Cubique.prototype.showData=function Cubique_showData(){var d=this.getObjectSize(this.columns);var e=$('<tr><td colspan="'+d+'" class="loading">.</td></tr>');var c=setInterval(function(){$(".loading").html($(".loading").html()+".")},50);this.tbody.html(e);var b=this;var a=new Date();$.ajax({type:"post",data:{cubique:{name:b.name,curr_page:b.currPage,sort:b.sort,search:b.search,rows_on_page:b.rowsOnPage}},url:(b.url?b.url:location.href)+"?nocache="+a.getTime(),dataType:"json",success:function(g){if(g.error){b.tbody.html('<tr><td colspan="'+d+'" class="error">'+b.error_message+"</td></tr>")}else{b.count=g.count;var h="";for(var i in g.data){h+="<tr>";for(var f in g.data[i]){if(null==g.data[i][f]){g.data[i][f]=""}h+="<td>"+g.data[i][f]+"</td>"}h+="</tr>"}b.tbody.html(h);$("table.cubique tbody td").mouseover(function(){$(this).parent().addClass("hovered")}).mouseleave(function(){$(this).parent().removeClass("hovered")});b.thead.find(".pages").remove();b.renderPagesSection()}clearInterval(c);e.remove()}})};Cubique.prototype.renderPagesSection=function Cubique_renderPagesSection(){var b="";var a=Math.ceil(this.count/this.rowsOnPage);var g=1;var h=a;var k='<span class="more">...</span>';if(a>10){if(this.currPage<=6){g=1;h=10}else{if(a-this.currPage<=5){g=a-11;h=a;b+=this.getGoToPageLink(1,false)+k}else{g=this.currPage-5;h=(this.currPage+5<=a)?this.currPage+5:a;b+=this.getGoToPageLink(1,false);if(this.currPage>7){b+=k}}}}var d=null;for(d=g;d<=h;d++){b+=this.getGoToPageLink(d,d==this.currPage)}if(a>h){if(a-this.currPage>=7){b+=k}b+=this.getGoToPageLink(a,false)}var f='<select class="per-page">';var c=null;for(c in this.perPageOptions){f+='<option value="'+this.perPageOptions[c]+'">'+this.perPageOptions[c]+"</option>"}f+="</select>";this.thead.append($('<tr class="pages"><th colspan="'+this.getObjectSize(this.columns)+'">'+b+'<a href="#" class="csv">csv</a><a href="#" class="refresh">refresh</a>'+f+'<span class="in-total">'+this.count+" in total</span></th></tr>"));var e=this;this.thead.find(".go-to-page").click(function(){e.currPage=parseInt($(this).attr("data-number"));e.setState("currPage",e.currPage);e.showData();return false});this.thead.find(".per-page").change(function(){e.rowsOnPage=$(this).val();e.setState("rowsOnPage",e.rowsOnPage);e.setState("currPage",1);e.currPage=1;e.showData();return false}).val(this.rowsOnPage);this.thead.find(".refresh").click(function(){e.showData();return false});this.thead.find(".csv").click(function(){data={cubique:{name:e.name,curr_page:e.currPage,sort:e.sort,search:e.search,rows_on_page:e.rowsOnPage}};data=e.stringify(data);document.location.href=(e.url?e.url:location.href)+"?cubique_data="+encodeURIComponent(data);return false})};Cubique.prototype.getGoToPageLink=function Cubique_getGoToPageLink(b,a){return'<a href="#" class="go-to-page'+(a?" curr":"")+'" data-number="'+b+'">'+b+"</a>"};Cubique.prototype.getObjectSize=function Cubique_getObjectSize(c){var b=0;for(var a in c){if(c.hasOwnProperty(a)){b++}}return b};Cubique.prototype.isLocalStorageAvailable=function Cubique_isLocalStorageAvailable(){try{return"localStorage" in window&&window.localStorage!==null}catch(a){return false}};Cubique.prototype.makeSearch=function Cubique_makeSearch(d,c){var a=d.attr("data-column");var b=[d.val(),c.val()];if(this.searchValues[a]!=b){this.search[a]=b;this.setState("currPage",1);this.setState("search",this.stringify(this.search));this.searchValues[a]=b;this.currPage=1;this.showData()}};Cubique.prototype.setCookie=function Cubique_setCookie(c,d){var b=new Date();var a=new Date();a.setTime(b.getTime()+3600000*24*10);document.cookie=c+"="+d+";expires="+a.toGMTString()+";path=/"};Cubique.prototype.getCookie=function Cubique_getCookie(b){var d=" "+document.cookie;var c=" "+b+"=";var e="";var f=0;var a=0;if(d.length>0){f=d.indexOf(c);if(f!=-1){f+=c.length;a=d.indexOf(";",f);if(a==-1){a=d.length}e=d.substring(f,a)}}return(e)};Cubique.prototype.stringify=function Cubique_stringify(e){if("JSON" in window){return JSON.stringify(e)}var d=typeof(e);if(d!="object"||e===null){if(d=="string"){e='"'+e+'"'}return String(e)}else{var f,b,c=[],a=(e&&e.constructor==Array);for(f in e){b=e[f];d=typeof(b);if(e.hasOwnProperty(f)){if(d=="string"){b='"'+b+'"'}else{if(d=="object"&&b!==null){b=this.stringify(b)}}c.push((a?"":'"'+f+'":')+String(b))}}return(a?"[":"{")+String(c)+(a?"]":"}")}};Cubique.prototype.getState=function Cubique_getState(a){a=this.name+"_"+a;if(this.isLocalStorageAvailable()){return localStorage.getItem(a)}else{return this.getCookie(a)}};Cubique.prototype.setState=function Cubique_setState(a,b){a=this.name+"_"+a;if(this.isLocalStorageAvailable()){localStorage.setItem(a,b)}else{this.setCookie(a,b)}};