/**
 * Cubique
 * @author    Alexander Plutov
 * @copyright (c) 2011-2012 Alexander Plutov
 * @link      https://github.com/plutov/cubique
 * @license   https://github.com/plutov/cubique/blob/master/LICENSE
 */
Cubique=function(k){$.extend(this,k);this.count=0;this.currPage=1;this.sort="";this.search={};this.searchValues={};try{this.isLocalStorageAvailable="localStorage" in window&&window.localStorage!==null}catch(f){this.isLocalStorageAvailable=false}var h=[10,25,50,100],g=parseInt(this.getState("rowsOnPage")),d=parseInt(this.getState("currPage")),i=this.getState("sortColumn"),m=this.getState("sortOrder"),b=this,a=$.parseJSON(b.getState("search"));h.push(this.rowsOnPage);h.sort(function(j,e){return j-e});h.join();if(i&&m){this.sort=i+" "+m}if(g&&$.inArray(g,h)!=-1){this.rowsOnPage=g;if(d){this.currPage=d}}else{this.setState("rowsOnPage",this.rowsOnPage);this.setState("currPage",this.currPage)}if(a){this.search=a}this.perPageOptions={};for(var c in h){this.perPageOptions[h[c]]=h[c]}this.renderGrid();this.showData()};Cubique.prototype.renderGrid=function Cubique_renderGrid(){var m='<table class="cubique"><thead><tr>',e="",r=this.getState("sortColumn"),s=this.getState("sortOrder"),o="",n="ASC";for(var h in this.columns){if(typeof(this.columnsToSort[h])!="undefined"){o=(r==this.columnsToSort[h])?(s=="ASC"?"&#9660":"&#9650"):"";n=(r==this.columnsToSort[h])?(s=="ASC"?"DESC":"ASC"):"ASC";e='<span class="order">'+o+'</span> <a href="#" title="Sort by '+this.columns[h]+'" class="sort-by" data-column="'+h+'" data-order="'+n+'">'+this.columns[h]+"</a>"}else{e=this.columns[h]}m+="<th>"+e+"</th>"}m+="</tr>";if(this.getObjectSize(this.columnsToSearch)){m+="<tr>";var a=tempSearchType="",p=["LIKE","NOT LIKE","=","<>","<",">","<=",">="];for(var g in this.columns){e="";if(typeof(this.columnsToSearch[g])!="undefined"){a=(typeof(this.search[g])!="undefined")?this.search[g][0]:"";tempSearchType=(typeof(this.search[g])!="undefined")?this.search[g][1]:"";e+='<select class="search-type" title="Search type">';for(var f in p){e+='<option value="'+p[f]+'"'+(tempSearchType==""+p[f]+""?" selected=selected":"")+">"+p[f]+"</option>"}e+='</select><input type="text" data-column="'+g+'" placeholder="search" value="'+a+'"/> <a href="#" class="reset-search" title="Reset search">&times;</a>';this.searchValues[g]=(typeof(this.search[g])!="undefined")?this.search[g]:""}m+="<th>"+e+"</th>"}m+="</tr>"}m+="</thead><tbody></tbody></table>";$("#cubique-"+this.name).html(m);var c="ASC",b="",d=this,q=$("#cubique-"+this.name+" a.sort-by");q.click(function(){q.prev("span").html("");c=$(this).attr("data-order");b=$(this).attr("data-column");d.currPage=1;d.sort=b+" "+c;d.setState("currPage",1);d.setState("sortColumn",b);d.setState("sortOrder",c);$(this).attr("data-order",c=="ASC"?"DESC":"ASC");$(this).prev("span").html(c=="ASC"?"&#9660;":"&#9650;");d.showData();return false});$("#cubique-"+this.name+" input").keyup(function(){d.makeSearch($(this),$(this).prev("select"));return false});$("#cubique-"+this.name+" .search-type").change(function(){d.makeSearch($(this).next("input"),$(this));return false});$("#cubique-"+this.name+" .reset-search").click(function(){var j=$(this).prev(),i=j.prev();j.val(null);i.val("LIKE");d.makeSearch(j,i);return false});this.tbody=$("#cubique-"+this.name+" tbody");this.thead=$("#cubique-"+this.name+" thead")};Cubique.prototype.showData=function Cubique_showData(){var d=this.getObjectSize(this.columns),e=$('<tr><td colspan="'+d+'" class="loading">.</td></tr>'),c=setInterval(function(){$(".loading").html($(".loading").html()+".")},50),a=this,b=new Date();this.tbody.html(e);$.ajax({type:"post",data:a.getPostData(),url:(a.url?a.url:location.href)+"?nocache="+b.getTime(),dataType:"json",success:function(g){if(g.error){a.tbody.html('<tr><td colspan="'+d+'" class="error">'+a.error_message+"</td></tr>")}else{a.count=g.count;var h="";for(var i in g.data){h+="<tr>";for(var f in g.data[i]){if(null==g.data[i][f]){g.data[i][f]=""}h+="<td>"+g.data[i][f]+"</td>"}h+="</tr>"}a.tbody.html(h);$("table.cubique tbody td").mouseover(function(){$(this).parent().addClass("hovered")}).mouseleave(function(){$(this).parent().removeClass("hovered")});a.thead.find(".pages").remove();a.renderPagesSection()}clearInterval(c);e.remove()}})};Cubique.prototype.renderPagesSection=function Cubique_renderPagesSection(){var b="",f=to=Math.ceil(this.count/this.rowsOnPage),h=1,g='<span class="more">...</span>';if(f>10){if(this.currPage<=6){h=1;to=10}else{if(f-this.currPage<=5){h=f-11;to=f;b+=this.getGoToPageLink(1,false)+g}else{h=this.currPage-5;to=(this.currPage+5<=f)?this.currPage+5:f;b+=this.getGoToPageLink(1,false);if(this.currPage>7){b+=g}}}}for(var e=h;e<=to;e++){b+=this.getGoToPageLink(e,e==this.currPage)}if(f>to){if(f-this.currPage>=7){b+=g}b+=this.getGoToPageLink(f,false)}var a='<select class="per-page" title="Rows on page">';for(var d in this.perPageOptions){a+='<option value="'+this.perPageOptions[d]+'">'+this.perPageOptions[d]+"</option>"}a+="</select>";this.thead.append($('<tr class="pages"><th colspan="'+this.getObjectSize(this.columns)+'">'+b+'<a href="#" class="csv" title="Export to CSV">csv</a><a href="#" class="refresh" title="Refresh page">refresh</a>'+a+'<span class="in-total">'+this.count+" in total</span></th></tr>"));var c=this;this.thead.find(".go-to-page").click(function(){c.currPage=parseInt($(this).attr("data-number"));c.setState("currPage",c.currPage);c.showData();return false});this.thead.find(".per-page").change(function(){c.rowsOnPage=$(this).val();c.setState("rowsOnPage",c.rowsOnPage);c.setState("currPage",1);c.currPage=1;c.showData();return false}).val(this.rowsOnPage);this.thead.find(".refresh").click(function(){c.showData();return false});this.thead.find(".csv").click(function(){var i=c.stringify(c.getPostData());document.location.href=(c.url?c.url:location.href)+"?cubique_data="+encodeURIComponent(i);return false})};Cubique.prototype.getGoToPageLink=function Cubique_getGoToPageLink(b,a){return'<a href="#" title="Go to page '+b+'" class="go-to-page'+(a?" curr":"")+'" data-number="'+b+'">'+b+"</a>"};Cubique.prototype.getObjectSize=function Cubique_getObjectSize(c){var b=0;for(var a in c){if(c.hasOwnProperty(a)){b++}}return b};Cubique.prototype.makeSearch=function Cubique_makeSearch(d,c){var a=d.attr("data-column"),b=[d.val(),c.val()];if(this.searchValues[a]!=b){this.search[a]=b;this.setState("currPage",1);this.setState("search",this.stringify(this.search));this.searchValues[a]=b;this.currPage=1;this.showData()}};Cubique.prototype.stringify=function Cubique_stringify(e){if("JSON" in window){return JSON.stringify(e)}var d=typeof(e);if(d!="object"||e===null){if(d=="string"){e='"'+e+'"'}return String(e)}else{var f,b,c=[],a=(e&&e.constructor==Array);for(f in e){b=e[f];d=typeof(b);if(e.hasOwnProperty(f)){if(d=="string"){b='"'+b+'"'}else{if(d=="object"&&b!==null){b=this.stringify(b)}}c.push((a?"":'"'+f+'":')+String(b))}}return(a?"[":"{")+String(c)+(a?"]":"}")}};Cubique.prototype.getState=function Cubique_getState(c){c=this.name+"_"+c;if(this.isLocalStorageAvailable){return localStorage.getItem(c)}else{var b=" "+document.cookie,a=" "+c+"=",d="",e=end=0;if(b.length>0){e=b.indexOf(a);if(e!=-1){e+=a.length;end=b.indexOf(";",e);if(end==-1){end=b.length}d=b.substring(e,end)}}return(d)}};Cubique.prototype.setState=function Cubique_setState(b,c){b=this.name+"_"+b;if(this.isLocalStorageAvailable){localStorage.setItem(b,c)}else{var a=expire=new Date();expire.setTime(a.getTime()+864000000);document.cookie=b+"="+c+";expires="+expire.toGMTString()+";path=/"}};Cubique.prototype.getPostData=function Cubique_getPostData(){return{cubique:{name:this.name,curr_page:this.currPage,sort:this.sort,search:this.search,rows_on_page:this.rowsOnPage}}};